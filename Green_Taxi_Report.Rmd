---
title: "Green Taxi Case Study"
author: "Chengran Ouyang"
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: lumen
    number_sections: true
    font-family: Open Sans, sans-serif
    font-import: https://fonts.googleapis.com/css?family=Open+Sans
    # code_folding: hide
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Step 1: Define the Problem
**Requirment:**

1. Download the data, load it into your favorite statistical programing software or database.
Report the number of rows and columns that you've loaded.

2. Visualize trip distance by time of day in any way you see fit, any observations?

3. What are the most popular pickup locations on weekdays vs weekend?

4. I want to know where I can most easily get a cab. Recommend a pick up spot where i can
find a cab given my lat long.

This time, I would use **R** as the programing software for the analysis. The analysis would be based on a standard data science framework and the questions above; however, I would extend the scope of the analysis to identify any unique insight as well as provide detailed explaination of my code.

The Process of Coding is available via [my github account](https://github.com/couyang24?tab=repositories).

# Step 2: Gather the Data
The scope of data is limited to Green taxi data for February 2016. There is also data dictionary available from the website, which explain the variable. The Data is available via [NYC Trip Data](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml).

# Step 3: Preprocess the Data

## Dependencies {.tabset}
### Required libraries

```{r }
# pacman package install required packages if not available 
if (!require("pacman")) install.packages("pacman") 
pacman::p_load(tidyverse, DT, lubridate, leaflet, leaflet.extras, maps, data.table, ggthemes, rebus)
```

### Required Dataset

```{r }
# Initially use read.csv then write the file so that going forward I can use fread
# data <- read.csv("green_tripdata_2016-02.csv", stringsAsFactors = F)
# write_csv(data,"green_tripdata_2016-02v2.csv")
data <- fread("green_tripdata_2016-02v2.csv", stringsAsFactors = F, data.table = FALSE, na.strings=c("NA","NaN","?", ""),
              showProgress = F)
```

## First Glimpse {.tabset}
### First 20 rows

```{r }
data %>% head(20) %>% datatable()
```

### Structure
The second question can be answered by looking at the structure of the dataset. The dataset has `r nrow(data)` observations(rows) and `r ncol(data)` variables(columns).
```{r }
data %>% str() # 1510722 obs. of  21 variables
```

### Summary

```{r }
data %>% summary()
```

## Data Cleaning: Correcting, Completing, Creating, and Converting {.tabset}
### Correcting
From the 
```{r }
data <- data %>% mutate(lpep_pickup_datetime = ymd_hms(lpep_pickup_datetime),
                pickup_hour=hour(lpep_pickup_datetime)+1,
                pickup_weekday=as.factor(weekdays(lpep_pickup_datetime)),
                pickup_weekend=if_else(pickup_weekday=='Saturday'|pickup_weekday=='Sunday','Weekend','Weekday'),
                Lpep_dropoff_datetime = ymd_hms( Lpep_dropoff_datetime),
                dropoff_hour=hour(lpep_pickup_datetime)+1,
                dropoff_weekday=as.factor(weekdays(lpep_pickup_datetime)))
```

##visu
```{r }
round_num <- 3

Weekend_Top5 <- data %>% filter(pickup_weekend=='Weekend') %>% 
  group_by(lng=round(Pickup_longitude,round_num),lat=round(Pickup_latitude,round_num)) %>% 
  count() %>% arrange(desc(n)) %>% head(5)

Weekday_Top5 <- data %>% filter(pickup_weekend=='Weekday') %>% 
  group_by(lng=round(Pickup_longitude,round_num),lat=round(Pickup_latitude,round_num)) %>% 
  count() %>% arrange(desc(n)) %>% head(5)


greentaxi <- makeIcon(
  iconUrl = "https://i.imgur.com/6rw618Q.png",
  iconWidth = 38, iconHeight = 35,
  iconAnchorX = 19, iconAnchorY = 39
)

Weekday_Top5 %>%
  leaflet() %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>%
  addCircleMarkers(~lng, ~lat, radius = 1,
                   color = "firebrick", fillOpacity = 0.001)%>%
  addMarkers(~lng, ~lat, icon = greentaxi)

Weekend_Top5 %>%
  leaflet() %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>%
  addCircleMarkers(~lng, ~lat, radius = 1,
                   color = "firebrick", fillOpacity = 0.001)%>%
  addMarkers(~lng, ~lat, icon = greentaxi)
```